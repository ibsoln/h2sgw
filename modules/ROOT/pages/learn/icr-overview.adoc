= Inter-Cluster Replication
:page-layout: article
:page-status: {release-status-sgw} -- {release-comments-sgw}
:page-edition: Under Develoment
:page-role:

include::shared-mobile::partial$_attributes-shared.adoc[]
include::partial$_attributes-local.adoc[]
:xref-pfx-sgw: {xref-pfx-sgw}:
include::partial$_page-index.adoc[]
include::partial$_glossary-links.adoc[]

ifndef::release-status-sgw[:release-status-sgw!:]
ifeval::["{release-status-sgw}" == "gamma"]
[.pane__frame--orange]
.Author's Notes
--
Create an overview of the Sync Gateway replication process

.points to include

* replicator diagram https://docs.google.com/document/d/13E6JOq8u_AaUd_t8FZEPCAuq7jfkjryecjBQBHE3pG8/edit#heading=h.33gfct4o4z8t


High level intro with links to appropriate details topics

Document replication concepts and use-cases
High-availability sync-gateway cluster replication
Persistent vs Transient replication types
Replication use cases:
mobile cluster replications
cloud-edge/hub-spoke replication
--
endif::[]

[abstract]
--
This content provides an overview of, and introduction to, Sync Gateway to Sync Gateway replication. Inter-cluster replication, uses SG Replicate protocol to enable replication between mobile clusters. That is, for example between a hub and its spoke clusters.
--

== Introducing Inter-cluster Replication

Couchbase Sync Gateway supports _{glos-term-inter-cluster-replication}_, an increasingly important enterprise-level requirement that
supports _{glos-term-cloud-to-edge} synchronization_ use cases, where data changes must be synchronized between a centralized cloud cluster and a large number of edge clusters whilst still enforcing fine grained access control.

Inter-cluster repliaction provides the ability to run replications between:

* Sync Gateway clusters
* Active mobile clusters.

Sync Gateway's inter-cluster replication feature uses the SG-Replicate 2.0  protocol. It is an integral part of Sync Gateway, acting as the _{glos-term-active-replicator}_, pulling changes from a data source and pushing them to a target.

.Inter-cluster replication architecture
[[icr-architecture]]
image::icr-replication-overview.svg[]

All documents pass through the target Sync Gateway's _{glos-term-sync-function}_ instance, ensuring that access rules are honored.

In the architecture diagram (<<icr-architecture>>), any changes that users/systems make on either Sync Gateway instance will be replicated to the other Sync Gateway instance.

== Features

[.pane__frame--orange]
.Author's Notes
--
Expand on the following list. Include cross-references to their topic page/section as appropriate
--

* Persistent vs Transient replication types
* Replication use cases: see <<typical-inter-cluster-replication-use-cases, Started - see above>>
** Mobile cluster replications
** Cloud-edge/hub-spoke replication
* {xref-sgw-pg-icr-high-availability} (HA)
* {xref-sgw-pg-icr-delta-sync} option
* Replicates via the Sync Gateway REST API (see: {xref-sgw-pg-adv-rest-api-client})
* Scalability
* JSON configuration to specify replications
* Supports multiple replications running concurrently
* Supports multile replication types: _{glos-term-persistent-replication}_ and _{glos-term-transient-replication}_
* Leverages the full duplex nature of websockets to support push and pull from a single connection
* Does not store anything persistently
* Stateless -- can be interrupted/restarted anytime without negative side effects
* Can specify which channel(s) to sync
* Supports Primary/Primary and Primary/Secondary topologies



== Typical Inter-cluster Replication Use Cases

=== Cloud-to-Edge Synchronization

A typical architecture for this use cases is shown in <<icr-cloud-to-edge>>

.Cloud-to-edge synchronization
[[icr-cloud-to-edge]]
image::icr-cloud-to-edge.svg[]

=== Active-to-active Mobile Synchronization

The performant SG-replicate 2.0 prototcol is ideal where Sync Gateway, deployments require data replication between active mobile clusters.

A typical architecture for this use cases is shown in <<icr-active-mobile>>

.Active-active mobile synchronization
[[icr-active-mobile]]
image::icr-active-mobile-sync.svg[]

=== Alternative Methods

xref:server:manage:manage-xdcr/xdcr-management-overview.adoc[XDCR] (cross data centre replication) is the Couchbase Server API to replicate between Couchbase Server clusters.
Both XDCR and SG Replicate can be used to keep clusters in different data centres in sync.
However, SG Replicate was designed specifically for Couchbase Mobile deployments and must be used for replication between mobile clusters.

== Limitations and Constraints

[.pane__frame--orange]
.Author's Notes
--
Expand on the following list. Include cross-references to their topic page/section as appropriate
--

* Can only replicate SG databases that are hosted on recent versions of Sync Gateway (after commit 50d30eb3d on March 7, 2014)
* In deployments with multiple Sync Gateway nodes, only _one_ of the Sync Gateways should be configured for replications.
If multiple Sync Gateways are configured for replications, it could substantially increase the amount of duplicate work, and therefore should be avoided.
The limitation is that the system is not guaranteed to be Highly Available: if the Sync Gateway that is chosen to drive the replication goes down or is otherwise removed from the system, then the replications will stop.
* Replication between Sync Gateway databases doesn't support automatic conflict resolution even when the no-conflicts mode is enabled (i.e xref:config-properties.adoc#databases-foo_db-allow_conflicts["allow_conflicts": false]).
When running two Sync Gateway clusters with the no-conflicts mode enabled, cross-cluster document conflicts will result in that document no longer being replicated.
Deployments  must implement a custom conflict resolver in an external app as specified xref:resolving-conflicts.adoc[here].
To avoid this, the application must ensure concurrent, cross-cluster updates are not made to a given document.


[.pane__frames.cols-3]
== Related Content

.How-to ...

* include how-to links as relevant,
* include how-to links as relevant,

.Learn more ...

include::partial$_related-content.adoc[tags=icr]

.Dive Deeper ...

* Reference content
** {xref-sgw-pg-config-properties}
include::partial$_related-content.adoc[tags=community]
